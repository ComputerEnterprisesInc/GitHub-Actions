#
#  Author: Hari Sekhon
#  Date: 2022-05-20 09:14:27 +0100 (Fri, 20 May 2022)
#
#  vim:ts=2:sts=2:sw=2:et
#
#  https://github.com/HariSekhon/GitHub-Actions
#
#  License: see accompanying Hari Sekhon LICENSE file
#
#  If you're using my code you're welcome to connect with me on LinkedIn and optionally send me feedback to help steer this or other code I publish
#
#  https://www.linkedin.com/in/HariSekhon
#

# Generates an AWS CodeArtifact auth token in the secrets for the local repo to minimize Docker cache misses

---
name: CodeArtifact Secret

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_DEFAULT_REGION:
        required: true
      CODEARTIFACT_DOMAIN:
        required: true

defaults:
  run:
    shell: bash -euxo pipefail {0}

jobs:
  codeartifact_token:
    name: Generate CODEARTIFACT_AUTH_TOKEN Secret
    runs-on: ubuntu-latest
    steps:
      - name: Environment
        run: env | sort

      - name: Configure AWS credentials
        id: configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Generate CODEARTIFACT_AUTH_TOKEN environment variable
        run: |
          # don't shell trace this step because it will expose the token in the logs
          set +x
          CODEARTIFACT_AUTH_TOKEN="$(aws codeartifact get-authorization-token --domain "${{ secrets.CODEARTIFACT_DOMAIN }}" --domain-owner "${{ steps.configure-aws-credentials.outputs.aws_account_id }}" --query authorizationToken --output text)"
          echo "CODEARTIFACT_AUTH_TOKEN=$CODEARTIFACT_AUTH_TOKEN" >> "$GITHUB_ENV"
          echo "::add-mask::$CODEARTIFACT_AUTH_TOKEN"

      - name: Upload CODEARTIFACT_AUTH_TOKEN to GitHub Repo Secret
        run: |
          gh secret set 'CODE_ARTIFACT_AUTH_TOKEN' --body "$CODEARTIFACT_AUTH_TOKEN"
